#!/bin/sh
#
# Auto installer for Fedora packages and dot files
dotrepo=${dotrepo:-"https://gitlab.com/mark.feller/rice.git"}
pkgfile=${pkgfile:-"https://gitlab.com/mark.feller/rice/raw/master/pkgs/fedora/packages"}
logfile=${logfile:-"/var/log/rice.log"}

log() { printf '\033[1;33m%s \033[m%s\033[m %s\n' "->" "${2:+[1;36m}$1${2:+[m}" "$2" | tee "$logfile"; }
die() { log "$2"; exit 1; }
try() { "$@" || die "Cannot $*"; }

trim_string() {
    # Usage: trim_string "   example   string    "
    trim=${1#${1%%[![:space:]]*}}
    trim=${trim%${trim##*[![:space:]]}}
    printf '%s\n' "$trim"
}

pre_install() {
    # Run any preinstall setup necessary

    log "Enabling RPM Fustion"
    try dnf install -y \
        https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-"$(rpm -E %fedora)".noarch.rpm \
        https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-"$(rpm -E %fedora)".noarch.rpm \
        >> "$logfile"

    log "Enabled i3-gaps community repo"
    dnf copr enable gregw/i3desktop >> "$logfile"

    log "Enabled alacritty community repo"
    dnf copr enable pschyska/alacritty >> "$logfile"
}

install_package() {
    # Install a single package $1 based on its flags $2
    
    case $2 in
        G)
            log "Installing go package $1"
            try go get -u "$1" >> "$logfile"
            ;;
        *)
            log "Installing $1..."
            try dnf install -y "$1" >> "$logfile"
            ;;
    esac
}

install_packages() {
    # Fetch the package file and install all packages
    
    # Copy a real file to our temp pkgfile or attempt to curl the pkgfile
    ([ -f "$pkgfile" ] && cp "$pkgfile" /tmp/pkgs) || (log "Downloading package list..." && curl -Ls "$pkgfile" > /tmp/pkgs)

    packages=$(sed '/^$/d' /tmp/pkgs | sed '/^#/d')
    while IFS='	' read -r flag program comment; do
        program=$(trim_string "$program")
        install_package $program $flag
    done <<EOF
$packages
EOF
}

install_dots() {
    # Clone and install dot files

    log "Fetching dot files"
    git clone "$dotrepo" ~/.config/rice >> "$logfile" || log "Dots have already been cloned"
    (cd ~/.config/rice && stow --target="$HOME" --ignore='gitignore' dots)
}


log "Running installer for Fedora"
pre_install
install_packages
install_dots
