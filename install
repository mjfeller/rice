#!/bin/sh
#
# Auto installer for macOS packages and dot files

log() { printf '\033[1;33m%s \033[m%s\033[m %s\n' "->" "${2:+[1;36m}$1${2:+[m}" "$2" ; }

# Determine which package manager exists on the system
if [ $(command -v dnf) ]; then
    log "Installing packages for Fedora"
    os=fedora
	installpkg() {
        log "Installing $1..."
        dnf install -y "$1"
    }
elif [ $(command -v xbps-install) ]; then
    log "Install packages for voidlinux"
    os=void
    installpkg() {
        xbps-install -Sy "$1" >/dev/null 2>&1
    }
elif [ $(command -v brew) ]; then
    log "Installing packages for macOS"
    os=macos
	installpkg() {
        case $2 in
            C)
                log "Installing $program cask..."
                brew cask install "$1" 2> /dev/null || brew cask upgrade "$1"
                ;;
            *)
                log "Installing $program..."
                brew install "$1" 2> /dev/null || brew upgrade "$1"
                ;;
        esac
    }
fi

dotsrepo=${dotfilesrepo:-"https://gitlab.com/mark.feller/rice.git"}
pkgfile=${pkgfile:-"https://gitlab.com/mark.feller/rice/raw/master/pkgs/$os/packages"}

trim_string() {
    # Usage: trim_string "   example   string    "
    trim=${1#${1%%[![:space:]]*}}
    trim=${trim%${trim##*[![:space:]]}}
    printf '%s\n' "$trim"
}

install_packages() {
    # Copy a real file to our temp pkgfile or attempt to curl the pkgfile
    ([ -f "$pkgfile" ] && cp "$pkgfile" /tmp/pkgs) || (log "Downloading package list..." && curl -Ls "$pkgfile" > /tmp/pkgs)

    packages=$(sed '/^$/d' /tmp/pkgs | sed '/^#/d')
    while IFS='	' read -r flag program comment; do
        program=$(trim_string "$program")
        installpkg $program $flag
    done <<EOF
$packages
EOF
}

install_dots() {
    git clone "$dotsrepo" ~/.config/rice || log "Dots have already been cloned"
    (cd ~/.config/rice && stow --target=$HOME --ignore='gitignore' dots)
}

pre_install() {
    # Enable RPM Fustion free and non-free on Fedora
    [ "$os" == "fedora" ] && {
        log "Enabling RPM Fustion"
        sudo dnf install -y \
             https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
             https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
    }
}

pre_install
install_packages
install_dots
